<!-- Header -->
<div class="header">
  <h1>Manage Tasks</h1>
  <div class="user-info">
    <div class="user-avatar">
      <%= user && user.username ? user.username.charAt(0).toUpperCase() : 'U' %>
    </div>
    <div>
      <div style="font-weight: 600;"><%= user && user.username ? user.username : 'User' %></div>
      <div style="color: #64748b; font-size: 0.875rem;"><%= user && user.role === 'ADMIN' ? 'Project Manager' : 'Team Member' %></div>
    </div>
  </div>
</div>

<!-- Task Creation Modal Popup -->
<div id="taskModalOverlay" style="position: fixed; inset: 0; background: rgba(30,41,59,0.8); backdrop-filter: blur(8px); z-index: 10000; display: none; align-items: center; justify-content: center;">
  <div id="taskModal" style="background: #1e293b; color: #ffffff; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); padding: 2rem; min-width: 400px; max-width: 90vw; text-align: center; position: relative; border: 1px solid rgba(255,255,255,0.1);">
    <button onclick="closeTaskModal()" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; color: #64748b; cursor: pointer; padding: 0.25rem;">&times;</button>
    <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“</div>
    <div style="font-weight: 700; font-size: 1.4rem; margin-bottom: 0.5rem; color: #ffffff;">Create New Task</div>
    <div style="margin-bottom: 1.5rem; color: #94a3b8;">Add a new task to keep track of your work and progress.</div>
    <form id="createTaskForm" style="text-align: left;">
      <div style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.5rem; color: #e2e8f0; font-weight: 500;">Task Title *</label>
        <input type="text" name="title" placeholder="e.g., Complete project setup" required style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid #475569; background: #334155; color: #ffffff; font-size: 0.9rem;">
      </div>
      <div style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.5rem; color: #e2e8f0; font-weight: 500;">Description</label>
        <textarea name="description" placeholder="Describe what this task involves..." style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid #475569; background: #334155; color: #ffffff; font-size: 0.9rem; min-height: 80px; resize: vertical;"></textarea>
      </div>
      <div style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.5rem; color: #e2e8f0; font-weight: 500;">Quest *</label>
        <select name="questId" required style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid #475569; background: #334155; color: #ffffff; font-size: 0.9rem;">
          <option value="">Select a quest...</option>
          <% if (typeof quests !== 'undefined' && quests && quests.length > 0) { %>
            <% quests.forEach(quest => { %>
              <option value="<%= quest._id.toString() %>"><%= quest.title %></option>
            <% }); %>
          <% } %>
        </select>
      </div>
      <div style="margin-bottom: 1.5rem;">
        <label style="display: block; margin-bottom: 0.5rem; color: #e2e8f0; font-weight: 500;">Priority</label>
        <select name="priority" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid #475569; background: #334155; color: #ffffff; font-size: 0.9rem;">
          <option value="LOW">Low</option>
          <option value="MEDIUM" selected>Medium</option>
          <option value="HIGH">High</option>
        </select>
      </div>
      <button type="submit" style="width: 100%; padding: 0.75rem; background: linear-gradient(45deg, #22c55e, #16a34a); color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.2s;">ğŸ“ Create Task</button>
    </form>
  </div>
</div>

<!-- Task Management Section -->
<div class="dashboard-main">
  <div class="analytics-section">
    <div class="section-header">
      <h2 class="section-title">Task Management</h2>
      <button onclick="openTaskModal()" class="btn btn-primary" style="background: linear-gradient(45deg, #22c55e, #16a34a);">ğŸ“ Create Task</button>
    </div>
    
    <!-- Task Filters -->
    <div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
      <select class="filter-dropdown">
        <option>All Tasks</option>
        <option>Pending</option>
        <option>Completed</option>
        <option>In Progress</option>
      </select>
      <select class="filter-dropdown">
        <option>All Priorities</option>
        <option>High Priority</option>
        <option>Medium Priority</option>
        <option>Low Priority</option>
      </select>
    </div>

    <!-- Tasks List -->
    <div class="tasks-list">
      <% if (tasks && tasks.length > 0) { %>
        <% tasks.forEach(task => { %>
          <div class="task-item" data-task-id="<%= task.id %>">
            <div class="task-info">
              <h4><%= task.title %></h4>
              <p><%= task.description || 'No description' %></p>
              <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                <span style="font-size: 0.75rem; color: #64748b;">Priority: <%= task.priority || 'Medium' %></span>
              </div>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
              <div class="task-status <%= task.completed ? 'status-completed' : 'status-pending' %>">
                <%= task.completed ? 'Completed' : 'Pending' %>
              </div>
              <button class="btn btn-secondary edit-task-btn" style="padding: 0.25rem 0.75rem; font-size: 0.75rem;">Edit</button>
              <button class="btn btn-secondary delete-task-btn" style="padding: 0.25rem 0.75rem; font-size: 0.75rem;">Delete</button>
            </div>
          </div>
        <% }) %>
      <% } else { %>
        <div class="task-item">
          <div class="task-info">
            <h4>No tasks found</h4>
            <p>Create your first task to get started</p>
          </div>
          <button onclick="openTaskModal()" class="btn btn-primary" style="background: linear-gradient(45deg, #22c55e, #16a34a);">Create Task</button>
        </div>
      <% } %>
    </div>
  </div>

  <!-- Task Statistics -->
  <div class="performance-card">
    <h2 class="performance-title">Task Statistics</h2>
    <div class="metric">
      <div class="metric-icon">ğŸ“</div>
      <div class="metric-info">
        <h3><%= tasks ? tasks.length : 0 %></h3>
        <p>total tasks</p>
      </div>
    </div>
    <div class="metric">
      <div class="metric-icon">âœ…</div>
      <div class="metric-info">
        <h3><%= tasks ? tasks.filter(t => t.completed).length : 0 %></h3>
        <p>completed</p>
      </div>
    </div>
    <div class="metric">
      <div class="metric-icon">â³</div>
      <div class="metric-info">
        <h3><%= tasks ? tasks.filter(t => !t.completed).length : 0 %></h3>
        <p>pending</p>
      </div>
    </div>
    <div class="metric">
      <div class="metric-icon">ğŸ“Š</div>
      <div class="metric-info">
        <h3><%= tasks && tasks.length > 0 ? Math.round((tasks.filter(t => t.completed).length / tasks.length) * 100) : 0 %>%</h3>
        <p>completion rate</p>
      </div>
    </div>
  </div>
</div>

<script>
// Modal open/close helpers
function closeTaskModal() {
  document.getElementById('taskModalOverlay').style.display = 'none';
}
function openTaskModal() {
  document.getElementById('taskModalOverlay').style.display = 'flex';
}

// Handle create task form submission
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('createTaskForm');
  if (form) {
    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const title = this.title.value.trim();
      const description = this.description.value.trim();
      const priority = this.priority.value;
      const questId = this.questId.value;
      
      // Validate required fields
      if (!title) {
        alert('Task title is required!');
        return;
      }
      
      if (!questId) {
        alert('Please select a quest for this task!');
        return;
      }
      
      // Disable submit button
      const submitBtn = this.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = 'ğŸ”„ Creating...';
      
      try {
        console.log('ğŸ“ Creating task via GraphQL:', { title, description, questId, priority });
        
        // Use GraphQL client to create task
        const result = await window.graphqlClient.createTask(title, description, questId, priority);
        console.log('âœ… Task created successfully:', result);
        
        // Check if we actually got a task back
        if (result && result.createTask) {
          console.log('âœ… Task creation confirmed:', result.createTask);
          
          // Success - close modal and reload
          closeTaskModal();
          window.location.reload();
        } else {
          console.warn('âš ï¸ Unexpected response format:', result);
          // Still close modal and reload since task might have been created
          closeTaskModal();
          window.location.reload();
        }
        
      } catch (error) {
        console.error('âŒ GraphQL error creating task:', error);
        
        // Check if it's just a response format issue but task was created
        if (error.message.includes('ID cannot represent')) {
          console.log('ğŸ”„ Possible ID conversion issue, but task might be created. Reloading...');
          closeTaskModal();
          window.location.reload();
        } else {
          alert('Error creating task: ' + error.message);
          
          // Re-enable button
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      }
    });
  }
});

// Handle delete task
// Add event listeners to all delete buttons
Array.from(document.getElementsByClassName('delete-task-btn')).forEach(btn => {
  btn.addEventListener('click', async function() {
    const taskId = this.closest('.task-item').getAttribute('data-task-id');
    if (!confirm('Are you sure you want to delete this task?')) return;
    
    try {
      console.log('ğŸ—‘ï¸ Deleting task via GraphQL:', taskId);
      
      // Use GraphQL client to delete task
      const data = await window.graphqlClient.deleteTask(taskId);
      console.log('âœ… Task deleted successfully:', data);
      
      // Reload to update the UI
      window.location.reload();
      
    } catch (error) {
      console.error('âŒ GraphQL error deleting task:', error);
      alert('Error deleting task: ' + error.message);
    }
  });
});

// You can similarly add edit functionality for tasks
// ...
</script>
