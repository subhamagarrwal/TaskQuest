<!-- Header -->
<div class="header">
  <h1>Quests List</h1>
  <div class="user-info">
    <div class="user-avatar">
      <%= user && user.username ? user.username.charAt(0).toUpperCase() : 'U' %>
    </div>
    <div>
      <div style="font-weight: 600;"><%= user && user.username ? user.username : 'User' %></div>
      <div style="color: #64748b; font-size: 0.875rem;"><%= user && user.role === 'ADMIN' ? 'Project Manager' : 'Team Member' %></div>
    </div>
  </div>
</div>

<!-- Quest Creation Modal Popup -->
<div id="questModalOverlay" style="position: fixed; inset: 0; background: rgba(30,41,59,0.8); backdrop-filter: blur(8px); z-index: 10000; display: none; align-items: center; justify-content: center;">
  <div id="questModal" style="background: #1e293b; color: #ffffff; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); padding: 2rem; min-width: 400px; max-width: 90vw; text-align: center; position: relative; border: 1px solid rgba(255,255,255,0.1);">
    <button onclick="closeQuestModal()" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; color: #64748b; cursor: pointer; padding: 0.25rem;">&times;</button>
    <div style="font-size: 3rem; margin-bottom: 1rem;">🎯</div>
    <div style="font-weight: 700; font-size: 1.4rem; margin-bottom: 0.5rem; color: #ffffff;">Create New Quest</div>
    <div style="margin-bottom: 1.5rem; color: #94a3b8;">Create a new quest to organize and track your team's objectives.</div>
    <form id="createQuestForm" style="text-align: left;">
      <div style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.5rem; color: #e2e8f0; font-weight: 500;">Quest Title *</label>
        <input type="text" name="title" placeholder="e.g., Complete Project Setup" required style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid #475569; background: #334155; color: #ffffff; font-size: 0.9rem;">
      </div>
      <div style="margin-bottom: 1.5rem;">
        <label style="display: block; margin-bottom: 0.5rem; color: #e2e8f0; font-weight: 500;">Description</label>
        <textarea name="description" placeholder="Describe what this quest involves..." style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid #475569; background: #334155; color: #ffffff; font-size: 0.9rem; min-height: 80px; resize: vertical;"></textarea>
      </div>
      <button type="submit" style="width: 100%; padding: 0.75rem; background: linear-gradient(45deg, #8b5cf6, #7c3aed); color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.2s;">🎯 Create Quest</button>
    </form>
  </div>
</div>

<!-- Quest Management Section -->
<div class="dashboard-main">
  <div class="analytics-section">
    <div class="section-header">
      <h2 class="section-title">Available Quests</h2>
      <button onclick="openQuestModal()" class="btn btn-primary" style="background: linear-gradient(45deg, #8b5cf6, #7c3aed);">🎯 Create Quest</button>
    </div>
    
    <!-- Quest Grid -->
    <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
      <% if (quests && quests.length > 0) { %>
        <% quests.forEach(quest => { %>
          <div class="dashboard-card">
            <div class="card-header">
              <div class="card-avatar" style="background: linear-gradient(45deg, #8b5cf6, #7c3aed); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">🎯</div>
              <div class="card-info">
                <h3><%= quest.title %></h3>
                <p><%= quest.description || 'No description' %></p>
              </div>
            </div>
            <div style="margin: 1rem 0;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="font-size: 0.875rem; color: #64748b;">Progress</span>
                <span style="font-size: 0.875rem; color: #64748b;"><%= quest.progress || 0 %>%</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: <%= quest.progress || 0 %>%;"></div>
              </div>
            </div>
            <div style="display: flex; gap: 0.5rem;">
              <button class="btn btn-primary" style="flex: 1; font-size: 0.875rem;">Join Quest</button>
              <button class="btn btn-secondary" style="padding: 0.5rem;">⚙️</button>
            </div>
          </div>
        <% }) %>
      <% } else { %>
        <div class="dashboard-card">
          <div class="card-header">
            <div class="card-avatar" style="background: linear-gradient(45deg, #64748b, #475569); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">❓</div>
            <div class="card-info">
              <h3>No Quests Available</h3>
              <p>Create your first quest to get started</p>
            </div>
          </div>
          <a href="#" onclick="openQuestModal(); return false;" class="btn btn-primary" style="width: 100%; text-align: center;">Create Quest</a>
        </div>
      <% } %>
    </div>
  </div>

  <!-- Quest Statistics -->
  <div class="performance-card">
    <h2 class="performance-title">Quest Stats</h2>
    <div class="metric">
      <div class="metric-icon">🎯</div>
      <div class="metric-info">
        <h3><%= quests ? quests.length : 0 %></h3>
        <p>total quests</p>
      </div>
    </div>
    <div class="metric">
      <div class="metric-icon">🏆</div>
      <div class="metric-info">
        <h3><%= quests ? quests.filter(q => q.completed).length : 0 %></h3>
        <p>completed</p>
      </div>
    </div>
    <div class="metric">
      <div class="metric-icon">🔄</div>
      <div class="metric-info">
        <h3><%= quests ? quests.filter(q => !q.completed && q.progress > 0).length : 0 %></h3>
        <p>in progress</p>
      </div>
    </div>
    <div class="metric">
      <div class="metric-icon">📈</div>
      <div class="metric-info">
        <h3><%= quests && quests.length > 0 ? Math.round(quests.reduce((acc, q) => acc + (q.progress || 0), 0) / quests.length) : 0 %>%</h3>
        <p>avg progress</p>
      </div>
    </div>
  </div>
</div>

<script>
// Modal open/close helpers
function closeQuestModal() {
  document.getElementById('questModalOverlay').style.display = 'none';
}
function openQuestModal() {
  document.getElementById('questModalOverlay').style.display = 'flex';
}

// Handle create quest form submission (POST to /quests)
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('createQuestForm');
  if (form) {
    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      const title = this.title.value;
      const description = this.description.value;
      
      try {
        const res = await fetch('/quests', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, description })
        });
        if (res.ok) {
          closeQuestModal();
          location.reload();
        } else {
          alert('Error creating quest');
        }
      } catch (error) {
        console.error('Error creating quest:', error);
        alert('Error creating quest');
      }
    });
  }
});
</script>
